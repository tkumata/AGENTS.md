---
name: embedded-c-coding
description: マイコンボード開発における組み込み C 言語の設計・実装・レビュー・リファクタ・テストを支援する。周辺ドライバ、割込み、タイミング制御、低消費電力、HAL 分離、ログ設計、Arduino IDE や Raspberry Pi Pico SDK などの環境が関わる依頼で使う。
---

# 組み込み C コーディング

## 前提

- 前提として AGENTS.md と GEMINI.md と CLAUDE.md を必ず遵守すること。

## 概要

マイコンボード向け C 言語実装を、最小の前提確認で安全に進めるための指針を提供する。
既存コード、既存ドキュメント、ボード固有の慣習を最優先に合わせる。

## 進め方

1. 対象ボードと開発環境を確認する。未確定なら仮定を明示する。
2. 目的と入出力、タイミング要件、割込み要件、低消費電力要件を確認する。
3. 既存コードの命名、モジュール分割、エラー方針、ログ方針に合わせる。
4. 変更範囲を最小化し、ユニットテストとオンターゲット確認の順で進める。

## コーディング指針

- `stdint.h` と `stdbool.h` を基本とし、サイズ明示型を用いる。
- `volatile` はハードウェアレジスタと ISR 共有変数に限定し、コメントで理由を示す。
- `static` で内部結合を明確にし、公開 API を最小化する。
- 副作用のある式やマクロは避け、必要なら関数化する。
- ループと分岐の最悪実行時間が読み取れる構造にする。

## 割込みと同時実行

- ISR は短く保ち、重い処理はフラグやリングバッファ経由でメインに移す。
- 共有データはクリティカルセクションを最小化し、必要ならアトミックまたは割込み禁止で保護する。
- レースが疑われる箇所は明示的にコメントし、再現条件を残す。

## 時間とタイミング

- タイムアウトと周期処理は単調増加カウンタを基準にする。
- 単位を明示し、必要なら ms/us/clock に変換関数を作る。

## ログとエラー

- エラーは戻り値で表現し、失敗時にログを残す。
- ログは抑制可能にし、量産ビルドで無効化できる設計にする。

## 移植性

- ボード依存部は HAL 層に閉じ込め、上位ロジックを分離する。
- Arduino IDE / Pico SDK などの環境差分は薄いラッパで吸収する。

## テスト

- 可能ならホスト上のユニットテストと、オンターゲットのスモークテストを併用する。
- クリティカルな境界条件は再現入力をコメントで残す。

## 参照

具体的な実装レシピとテンプレートは `references/embedded-workflows.md` を確認する。
